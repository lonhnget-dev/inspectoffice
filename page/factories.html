<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factories List | បញ្ជីរោងចក្រ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div id="sidebarContainer"></div>
    <script>
        fetch("../sidebar.html")
            .then(res => res.text())
            .then(html => { document.getElementById("sidebarContainer").innerHTML = html; })
            .catch(err => console.warn("Sidebar not found."));
    </script>

    <div class="p-4 sm:ml-64">
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-gray-500 text-sm font-medium">រោងចក្រ​សរុប</div>
                <div id="totalFactories" class="text-2xl font-bold text-blue-700">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-gray-500 text-sm font-medium">កម្មករសរុប</div>
                <div id="totalWorkers" class="text-2xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-gray-500 text-sm font-medium">ស្រី</div>
                <div id="totalFemale" class="text-2xl font-bold text-pink-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <div class="text-gray-500 text-sm font-medium">បរទេស</div>
                <div id="totalForeign" class="text-2xl font-bold text-purple-600">0</div>
            </div>
        </div>

        <h1 class="text-2xl font-bold text-gray-800 mb-4">បញ្ជីរោងចក្រ (Factory List)</h1>

        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
            <input type="text" id="searchInput" placeholder="ស្វែងរកឈ្មោះ ឬ កូដ..." 
                   class="px-3 py-2 border rounded-md w-full sm:w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="openAddModal()" class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center">
                <i class="ph ph-plus-circle mr-2 text-lg"></i> បន្ថែមរោងចក្រ
            </button>
        </div>

        <div class="relative overflow-x-auto shadow-md sm:rounded-lg bg-white border border-gray-200">
            <table id="factoriesTable" class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                    <tr>
                        <th class="px-4 py-3">Code</th>
                        <th class="px-4 py-3">ឈ្មោះរោងចក្រ (EN/KH)</th>
                        <th class="px-4 py-3">ព័ត៌មានអាជីវកម្ម</th>
                        <th class="px-4 py-3">អាសយដ្ឋាន</th>
                        <th class="px-4 py-3 text-center">ស្ថិតិកម្មករ</th>
                        <th class="px-4 py-3">ស្ថានភាព</th>
                        <th class="px-4 py-3 text-right">សកម្មភាព</th>
                    </tr>
                </thead>
                <tbody id="factoryBody"></tbody>
            </table>
        </div>
    </div>

    <div id="crud-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-6xl max-h-full">
            <div class="relative bg-white rounded-lg shadow">
                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-900 italic">បញ្ចូលព័ត៌មានរោងចក្រ</h3>
                    <button type="button" onclick="closeModal()" class="text-gray-400 bg-transparent hover:bg-gray-200 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center">
                        <i class="ph ph-x text-xl"></i>
                    </button>
                </div>

                <form id="factoryForm" class="p-6">
                    <h4 class="font-bold text-blue-700 mb-3 border-b pb-1 uppercase italic">1. General Info</h4>
                    <div class="grid gap-4 mb-6 md:grid-cols-4">
                        <div><label class="block mb-1 text-sm font-medium">កូដ (Code)</label><input type="text" id="code" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2" required></div>
                        <div><label class="block mb-1 text-sm font-medium">ឈ្មោះអង់គ្លេស (English Name)</label><input type="text" id="englishName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2" required></div>
                        <div><label class="block mb-1 text-sm font-medium">ឈ្មោះខ្មែរ</label><input type="text" id="khmerName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2" required></div>
                        <div><label class="block mb-1 text-sm font-medium">ស្ថានភាព (Status)</label>
                            <select id="status" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2">
                                <option value="Active">Active</option>
                                <option value="Suspended">Suspended</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                    </div>

                    <h4 class="font-bold text-blue-700 mb-3 border-b pb-1 uppercase italic">2. Location</h4>
                    <div class="grid gap-4 mb-6 md:grid-cols-4">
                        <div><label class="block mb-1 text-sm font-medium">ខេត្ត/ក្រុង</label><select id="province" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"><option value="">-- Select --</option></select></div>
                        <div><label class="block mb-1 text-sm font-medium">ស្រុក/ខណ្ឌ</label><select id="district" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"><option value="">-- Select --</option></select></div>
                        <div><label class="block mb-1 text-sm font-medium">ឃុំ/សង្កាត់</label><select id="commune" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"><option value="">-- Select --</option></select></div>
                        <div><label class="block mb-1 text-sm font-medium">ភូមិ</label><select id="village" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"><option value="">-- Select --</option></select></div>
                    </div>

                    <h4 class="font-bold text-blue-700 mb-3 border-b pb-1 uppercase italic">3. Statistics</h4>
                    <div class="grid gap-4 mb-6 md:grid-cols-5">
                        <div><label class="block mb-1 text-sm font-medium">កម្មករសរុប</label><input type="number" id="totalWorker" class="bg-gray-200 border text-sm rounded-lg w-full p-2" readonly></div>
                        <div><label class="block mb-1 text-sm font-medium">បុរស</label><input type="number" id="maleWorker" oninput="calcTotal()" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2" value="0"></div>
                        <div><label class="block mb-1 text-sm font-medium">ស្រី</label><input type="number" id="femaleWorker" oninput="calcTotal()" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2" value="0"></div>
                        <div><label class="block mb-1 text-sm font-medium">បរទេស</label><input type="number" id="foriegnWorker" oninput="calcTotal()" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2" value="0"></div>
                        <div><label class="block mb-1 text-sm font-medium">ស្រីបរទេស</label><input type="number" id="femaleForiegnWorker" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2" value="0"></div>
                    </div>

                    <h4 class="font-bold text-blue-700 mb-3 border-b pb-1 uppercase italic">4. Admin & Assistant</h4>
                    <div class="grid gap-4 mb-6 md:grid-cols-4">
                        <div><label class="block mb-1 text-sm font-medium">ឈ្មោះអ្នកគ្រប់គ្រង</label><input type="text" id="adminName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"></div>
                        <div><label class="block mb-1 text-sm font-medium">ទូរស័ព្ទអ្នកគ្រប់គ្រង</label><input type="text" id="adminPhone" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"></div>
                        <div><label class="block mb-1 text-sm font-medium">ឈ្មោះជំនួយ</label><input type="text" id="astName" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"></div>
                        <div><label class="block mb-1 text-sm font-medium">ទូរស័ព្ទជំនួយ</label><input type="text" id="astPhone" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"></div>
                    </div>

                    <h4 class="font-bold text-blue-700 mb-3 border-b pb-1 uppercase italic">5. Sector & Map</h4>
                    <div class="grid gap-4 mb-6 md:grid-cols-4">
                        <div><label class="block mb-1 text-sm font-medium">តំបន់ (Zone)</label><input type="text" id="zone" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"></div>
                        <div><label class="block mb-1 text-sm font-medium">តំណភ្ជាប់ផែនទី</label><input type="text" id="linkMape" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"></div>
                        <div><label class="block mb-1 text-sm font-medium">វិស័យ (Sector)</label><input type="text" id="sector" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"></div>
                        <div><label class="block mb-1 text-sm font-medium">ប្រភេទអាជីវកម្ម</label><input type="text" id="businessType" class="bg-gray-50 border border-gray-300 text-sm rounded-lg w-full p-2"></div>
                    </div>

                    <h4 class="font-bold text-blue-700 mb-3 border-b pb-1 uppercase italic">6. Owner & CEO</h4>
                    <div class="grid gap-4 mb-6 md:grid-cols-3">
                        <input type="text" id="ownerName" placeholder="ឈ្មោះម្ចាស់" class="text-sm p-2 border rounded">
                        <input type="text" id="ownerPhone" placeholder="ទូរស័ព្ទម្ចាស់" class="text-sm p-2 border rounded">
                        <input type="text" id="onwerNationality" placeholder="សញ្ជាតិម្ចាស់" class="text-sm p-2 border rounded">
                    </div>
                    <div class="grid gap-3 mb-6 md:grid-cols-3">
                        <input type="text" id="ceoName" placeholder="CEO Name" class="text-sm p-2 border rounded">
                        <input type="text" id="ceoPhone" placeholder="CEO Phone" class="text-sm p-2 border rounded">
                        <input type="text" id="ceoNationality" placeholder="CEO Nationality" class="text-sm p-2 border rounded">
                    </div>

                    <div class="grid gap-3 mb-6 md:grid-cols-2">
                        <textarea id="doc" rows="2" placeholder="Documents Link" class="text-sm p-2 border rounded w-full"></textarea>
                        <textarea id="remarks" rows="2" placeholder="Remarks" class="text-sm p-2 border rounded w-full"></textarea>
                    </div>

                    <div class="flex justify-end space-x-3 border-t pt-5">
                        <button type="button" onclick="closeModal()" class="text-gray-500 border rounded-lg text-sm px-5 py-2.5">Cancel</button>
                        <button type="submit" class="text-white bg-blue-700 rounded-lg text-sm px-10 py-2.5 font-bold">SAVE FACTORY</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
<script>
const apiUrl = "https://back-end-new-office.onrender.com/api/v1/factories";
const locApi = "https://back-end-new-office.onrender.com/api/v1/locations";
let allFactories = [];
let isEditMode = false;
let currentEditId = null;
let modalObj;

document.addEventListener('DOMContentLoaded', () => {
    modalObj = new Modal(document.getElementById('crud-modal'));
    fetchFactories();
    loadDropdown(`${locApi}/provinces`, 'province', 'Select Province');
});

// --- Location Fetchers ---
async function loadDropdown(url, elId, placeholder) {
    const el = document.getElementById(elId);
    el.innerHTML = `<option value="">Loading...</option>`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        el.innerHTML = `<option value="">-- ${placeholder} --</option>`;
        data.forEach(item => {
            const code = item.province_code || item.district_code || item.commune_code || item.village_code;
            const name = item.province_kh || item.district_kh || item.commune_kh || item.village_kh;
            el.innerHTML += `<option value="${code}">${name}</option>`;
        });
    } catch (e) { console.error(e); }
}

document.getElementById('province').onchange = (e) => {
    loadDropdown(`${locApi}/districts/${e.target.value}`, 'district', 'Select District');
};
document.getElementById('district').onchange = (e) => {
    loadDropdown(`${locApi}/communes/${e.target.value}`, 'commune', 'Select Commune');
};
document.getElementById('commune').onchange = (e) => {
    loadDropdown(`${locApi}/villages/${e.target.value}`, 'village', 'Select Village');
};

async function fetchFactories() {
    const res = await fetch(apiUrl);
    const data = await res.json();
    allFactories = Array.isArray(data) ? data : data.data;
    renderFactories(allFactories);
    updateStats(allFactories);
}

function renderFactories(list) {
    const tbody = document.getElementById("factoryBody");
    tbody.innerHTML = "";
    list.forEach(f => {
        tbody.innerHTML += `
        <tr class="bg-white border-b hover:bg-gray-50">
            <td class="px-4 py-4 font-bold text-blue-900">${f.id}</td>
            <td class="px-4 py-4">
                <div class="font-bold text-gray-900">${f.factoryEn}</div>
                <div class="text-xs text-gray-400">${f.factoryKh}</div>
            </td>
            <td class="px-4 py-4 text-xs"><b>S:</b> ${f.sector}</td>
            <td class="px-4 py-4 text-xs">${f.Province?.province_kh || ''}</td>
            <td class="px-4 py-4 text-center font-bold">${f.totalWorkers}</td>
            <td class="px-4 py-4"><span class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs">${f.status}</span></td>
            <td class="px-4 py-4 text-right">
                <button onclick="editFactory(${f.id})" class="text-blue-600 mr-2"><i class="ph ph-pencil-simple text-xl"></i></button>
                <button onclick="deleteFactory(${f.id})" class="text-red-600"><i class="ph ph-trash text-xl"></i></button>
            </td>
        </tr>`;
    });
}

document.getElementById("factoryForm").onsubmit = async (e) => {
    e.preventDefault();
    const payload = {
        factoryEn: document.getElementById("englishName").value,
        factoryKh: document.getElementById("khmerName").value,
        status: document.getElementById("status").value,
        sector: document.getElementById("sector").value,
        businessActivity: document.getElementById("businessType").value,
        province_code: parseInt(document.getElementById("province").value),
        district_code: parseInt(document.getElementById("district").value),
        commune_code: parseInt(document.getElementById("commune").value),
        village_code: parseInt(document.getElementById("village").value),
        totalWorkers: parseInt(document.getElementById("totalWorker").value),
        femaleWorkers: parseInt(document.getElementById("femaleWorker").value),
        foreignWorkers: parseInt(document.getElementById("foriegnWorker").value),
        adminPhone: document.getElementById("adminPhone").value,
        directorPhone: document.getElementById("ceoPhone").value,
        mapLink: document.getElementById("linkMape").value,
        remark: document.getElementById("remarks").value
    };

    const method = isEditMode ? "PUT" : "POST";
    const url = isEditMode ? `${apiUrl}/${currentEditId}` : apiUrl;

    const res = await fetch(url, {
        method, headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });
    if (res.ok) { modalObj.hide(); fetchFactories(); }
};

function editFactory(id) {
    isEditMode = true; currentEditId = id;
    const f = allFactories.find(x => x.id === id);
    document.getElementById("englishName").value = f.factoryEn;
    document.getElementById("khmerName").value = f.factoryKh;
    document.getElementById("ceoPhone").value = f.directorPhone || "";
    // Set other fields...
    modalObj.show();
}

function calcTotal() {
    const m = parseInt(document.getElementById('maleWorker').value) || 0;
    const f = parseInt(document.getElementById('femaleWorker').value) || 0;
    const fo = parseInt(document.getElementById('foriegnWorker').value) || 0;
    document.getElementById('totalWorker').value = m + f + fo;
}

function openAddModal() { isEditMode = false; document.getElementById("factoryForm").reset(); modalObj.show(); }
function closeModal() { modalObj.hide(); }
function updateStats(list) { document.getElementById("totalFactories").innerText = list.length; }
</script>
</body>
</html>